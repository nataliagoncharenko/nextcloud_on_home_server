# Установка Nextcloud на домащний Ubuntu Server на Dexp Compact M008

Устанавливаем Nextcloud через Docker контейнер

Создание папки для данных и запуск контейнера:

mkdir -p ~/nextcloud/data ~/nextcloud/db

Запуск Nextcloud с базой данных MariaDB через docker-compose.yml:

переходим в редактор nano:

nano ~/nextcloud/docker-compose.yml

yaml файл:

version: '3'
services:
  db:
    image: mariadb:10.6
    restart: always
    volumes:
      - ~/nextcloud/db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=пароль_для_root
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=пароль_для_nextcloud

  app:
    image: nextcloud:latest
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ~/nextcloud/data:/var/www/html
    depends_on:
      - db
    environment:
      - MYSQL_HOST=db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=пароль_для_nextcloud

Разберем yaml файл - это конфигурационный файл для Docker Compose, он является инструментом, который позволяет запускать несколько контейнеров сразу (базу данных и веб-приложение), связывать их между собой, настраивать тома, порты и переменные окружения. Этот файл запускает Nextcloud с базой данных MariaDB.
В качестве базы данных используется база данных MariaDB, т.к. она является бесплатным и безопасным вариантом:open-source, разрабатывается сообществом, она рекомендована экосистемой open-source (прямо указывается в документации о поддержке MariaDB), она является потомком MySQL, что означает совместимость на 99%, у нее есть улучшения "из коробки" (быстрые временные таблицы, больше движков хранения, улучшенная оптимизация запросов, встроенные параллельные запросы), поддержка в Docker (официальный образ mariadb в Docker Hub поддерживается разработчиками), активное развитие. 

В синтаксисе основным являются отступы, основными блоками являются разделы и все, что внутри раздела отделено отступами, является частью раздела, принцип вложенности. 

В указанном файле 2 раздела: 

1) version: '3'
Указывает версию синтаксиса Docker Compose, в данном случае - версия 3, является совремнной версией, которая поддерживает большинство фич. Является шапкой и указывает Docker как читать файл. 

2) services
В этом разделе указываются все контейнеры, которые нужно запустить. По отступам мы видим, что контейнеров 2: db (база-данных) app (веб-приложение Nextcloud). 

База данных и приложение живут в отдельных контейнеров, внутри них являются независимыми и "думают", что они одни. 

* Рассмотрим, что происходит в сервисе базы данных - db. содержит в себе (смотрим на первый отступ): образ, перезапуск, тома (volumes), окружение. 

image: mariadb:10.6 - берет готовый образ из Docker Hub
restart: always - автоматический перезапуск контейнера
volumes:
  - ~/nextcloud/db:/var/lib/mysql - связывает папку на сервере с папкой внутри контейнера. Слева от **двоеточия** - папка на сервере, справа - в контейнере. Означает что данные сохраняются не только в контейнере, но и в папке, и если контейнер удалится, данные останутся. 
environment: - передает переменные окружения в контейнер, аналог настроек
  - MYSQL_ROOT_PASSWORD=пароль_для_root
  - MYSQL_DATABASE=nextcloud - создание базы данных nextcloud
  - MYSQL_USER=nextcloud - пользователь базы данных 
  - MYSQL_PASSWORD=пароль_для_nextcloud

* Рассмотри второй сервис - app: 

app:
    image: nextcloud:latest - берет последнюю версию nextcloud из Docker Hub
    restart: always - автоматический перезапуск
    ports: - открывает порты на сервере и связывает с портами внутри контейнера
      - "80:80" - для доступа в локальной сети
      - "443:443" - был прописан для ZeroTier
    volumes: - сохранение данных Nextcloud на сервере
      - ~/nextcloud/data:/var/www/html (сервер **:** контейнер)
    depends_on: - означает, что Docker Compose необходимо перед запуском nextcloud запустить базу данных, без базы данных nextcloud не работает. 
      - db
    environment: - настройки для подключения nextcloud к MariaDB
      - MYSQL_HOST=db - имя **контейнера** с базой, Docker Compose связывает по имени. 
      Остальные повторяют строки из db:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=пароль_для_nextcloud

### Узкие места указанного docker-compose.yml

* ~/nextcloud/db:/var/lib/mysql - указаны абсолютные пути через ~ (домашняя директория /home/username) вместо относительного через . (текущая директория) - что делает yml файл непереносимым, контейнер не заработает, если сменится пользователь. В моем случае домашнего сервера с одним пользователем этот вариант сработал. 

* нет разграничения по пользователям (разобраться с этим)

* нет оптимизации с помощью Redis, кэширование может помочь работать быстрее на моем слабом железе мини ПК. 

## Как работает это дальше 

1) Docker Compose читает docker-compose.yml

2) Запускает контейнер с MariaDB, настраивает базу и сохраняет данные в указанную папку

3) Запускает контейнер с nextcloud, подключает его к базе данных, открывает порт, сохраняет файлы в указанную папку.

4) теперь можно открыть nectcloud в браузере. 

Задруживает контейнеры Docker Compose - без прямого участия разработчика он создает сеть благодаря тому, что указано в файле 

Запускаем Nextcloud:

cd ~/nextcloud
docker compose up -d

Базово был запущен указанный файл, но т.к. мой Dexp не мщное железо, то можно ускорить работу Nextcloud c помощью кэширования Redis. 
Добавим это в файл yaml. 